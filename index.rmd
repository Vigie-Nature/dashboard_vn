---
title: "Statistiques globales"
---

```{r setup, include=FALSE} 
knitr::opts_chunk$set(warning = FALSE, message = FALSE, echo = FALSE) 
library(leaflet)
library(sf)
library(tmap)
library(dplyr)
library(tidyr)
library(ggplot2)


# ggplot size 
theme_text_size <- theme( 
  axis.title = element_text(size = 15), 
  axis.text = element_text(size = 13), 
  legend.text = element_text(size = 12), 
  legend.title = element_text(size = 14))
```

```{r import data}
#import functions
source("fonctions/functions_restitution.R")
# import data
data_participation <- data.table::fread("data/vne_participation.csv")
annee_actuelle <- lubridate::year(Sys.time())
```

### Chiffres clés

- Nombre total participants : `r stats_globales(data_participation, compter = "profs")`
- Nombre total participants cette année : `r stats_globales(data_participation, compter = "profs", select_annee = annee_actuelle)`
- Nombre total de classes : `r stats_globales(data_participation, compter = "classes")`
- Nombre total de classes cette année : `r stats_globales(data_participation, compter = "classes", select_annee = annee_actuelle)`
- Nombre total de participations : `r stats_globales(data_participation, compter = "observations")`
- Nombre total de participations cette année : `r stats_globales(data_participation, compter = "observations", select_annee = annee_actuelle)`

### Informations sur les inscriptions

Un peu de blabla pour expliquer peut-être. Nouveaux utilisateurs en fonction de leur première participation sur la période étudiée.

```{r new users data}
#calculate new users

# get table of users per period
new_users <- data_participation %>%
  select(userpk, annee_scolaire) %>%
  distinct() %>%
  arrange(annee_scolaire) %>%
  data.table::setDF()

# get all years
years <- unique(new_users$annee_scolaire)
# all first users are new
new_users$new <- new_users[, "annee_scolaire"] == years[1]
# calculate next years 
for (i in years[2:length(years)]){
  former <- new_users[new_users[, "annee_scolaire"] < i, "userpk"]
  current <- new_users[new_users[, "annee_scolaire"] == i, "userpk"]
  new_users[new_users[ , "annee_scolaire"] == i, "new"] <- !current %in% former
}

# get count per categories
new_users_summary <- new_users %>%
  group_by(annee_scolaire, new) %>%
  summarise(nombre_users = n())

# rename categories
new_users_summary$type_user <- NA
new_users_summary$type_user[new_users_summary$new] <- "Nouveaux utilisateurs"
new_users_summary$type_user[!new_users_summary$new] <- "Utilisateurs ayant déjà participé"

# get nice labels
new_users_summary$annee_scolaire <- label_years(new_users_summary$annee_scolaire, retour = TRUE)

# plot results
ggplot(new_users_summary, aes(x = annee_scolaire, y = nombre_users)) +
  geom_col(aes(fill = type_user)) +
  labs(fill="Type d'utilisateurs", 
       x = "Année scolaire", 
       y = paste(strwrap("Nombre d'utilisateurs ayant envoyé des données", width = 35), collapse = "\n")) +
  theme_minimal() +
  theme(legend.position="bottom") +
  theme_text_size 

```

### variation temporelle du nombre de participants

Attention, cette représentation ne prend pas en compte les classes participant à **Vigie-Chiro** (15 à 25) et **BirdLab** (non déterminé)

```{r variation participants}
nombre_classes_an <- stats_globales(data_participation, select_annee = "table")
nombre_classes_an$annee_scolaire <- as.character(nombre_classes_an$annee_scolaire)
nombre_classes_an$labelsYears = label_years(nombre_classes_an$annee_scolaire, retour = TRUE)

ggplot(nombre_classes_an, aes(x = annee_scolaire, y = classes, group = 1)) +
  geom_line(color = "#00CC33", linewidth= 1) +
  geom_point(color = "#00CC33", size = 2) +
  geom_text(aes(label = classes), position = position_dodge(width = 1),
            vjust = +2, size = 3)+
  ylab("Nombre de classes \n participantes") +
  xlab("Années") +
  theme_minimal() +
  expand_limits(y=0) +
  scale_x_discrete(labels = nombre_classes_an$labelsYears) +
  theme_text_size 


```

### variation temporelle participations

```{r variation observation}
variable_focale = "observations"
type_annee = "civile"
type_annee = "scolaire"

evolution <- stats_globales(data_participation, select_annee = "table", compter = variable_focale)
evolution$annee_scolaire <- as.character(evolution$annee_scolaire)
evolution$labelsYears = label_years(evolution$annee_scolaire, retour = TRUE)

ggplot(evolution, aes(x = annee_scolaire, y = get(variable_focale), group = 1)) +
  geom_line(color = "#00CC33", size= 1) +
  geom_point(color = "#00CC33", size = 2) +
  geom_text(aes(label = get(variable_focale)), position = position_dodge(width = 1),
            vjust = +2, size = 3)+
  ylab("Nombre d'observations") +
  xlab("Années") +
  theme_minimal() +
  expand_limits(y=0) +
  scale_x_discrete(labels = evolution$labelsYears) +
  theme_text_size 


```

### Cartographie

Un exemple de carte dynamique


```{r dynamic carto observations}


# remove lost participations
data_participation <- data_participation[data_participation$latitude>1, ]

# transformation en objet spatial (on explique quelles sont les colonnes pour creer une "geometry")
geo_participation<- st_as_sf(data_participation, coords = c("longitude", "latitude"))
# choix de la projection (très important c'est tout un sujet en réalité)
st_crs(geo_participation) <- 4326

# Make dynamic map
observation_map <- leaflet(geo_participation) %>%
  addTiles()%>%
  addMarkers(clusterOptions = markerClusterOptions())
observation_map

```

Exemples de cartes statiques

```{r static carto observations}
# Make static map
# import maps
carte_france = read_sf("data/maps/metropole-version-simplifiee.geojson")
geo_grid_10k = sf::read_sf("data/maps/mailles10km.geojson")

# count each line within the shape layer
participation_layer <- count_values_within(geo_participation, geo_grid_10k, remove_empty = TRUE, value_name = "nombre_observations")

# start with background and layout
static_map_bg <- tm_shape(carte_france) + tm_borders(col = "#70cc08") + tm_layout(frame = FALSE, legend.outside = TRUE)
# shapefile operations
static_map_shape <- static_map_bg + tm_shape(participation_layer)
# add chloropeth
static_map_chlo <- static_map_shape + tm_fill(col = "nombre_observations", legend.hist = FALSE, n = 10, style = "fisher", palette = "-viridis")
# add bubbles
static_map_bubbl <- static_map_shape + tm_bubbles(size="nombre_observations", scale = .8, col = "nombre_observations", palette = "-viridis", style = "fisher", n = 10)
# add points
static_map_dots <- static_map_bg + tm_shape(geo_participation) + tm_dots()
static_map_dots_alpha <- static_map_bg + tm_shape(geo_participation) + tm_dots(alpha = .2)

static_map_chlo
static_map_bubbl
static_map_dots
static_map_dots_alpha


# # change layout 
# static_map <- static_map + tm_layout(frame = FALSE, legend.outside = TRUE)
# static_map
```


#### Des exemples de cartes dynamiques


#### Variation temporelle intra-annuelle


```{r}
graph <- graph_participation_par_mois(data_participation, annee_focale = annee_actuelle)

graph +
  theme_text_size 
```

